# 2.6 模式匹配

模式匹配判断一个值是否满足某些条件。它需要提供一个值和一个匹配模式。匹配模式声明一些条件，并判断值是否满足这些条件。匹配模式也会声明一些变量，若匹配通过，则可以使用这些变量。

为更好举例说明，先介绍可以使用模式匹配的语法。

## `is` 表达式

`is` 表达式语法如下：

```aoi
value is pattern
```

其中，`value` 是要匹配的值，`pattern` 是匹配模式。若匹配通过，则表达式值为 `true`，否则为 `false`。

`is` 表达式的匹配模式中不能声明变量。

例如：

```aoi
a is 42
```

其中，`42` 是最简单的一个匹配模式，它判断 `a` 是否与其相等。若 `a` 的值为 `42`，则表达式返回 `true`，否则表达式返回 `false`。

## `if is` 语句和 `if is` 表达式

`if is` 语句或表达式的语法如下：

```aoi
if value is pattern then branch0 else branch1
```

其中，`value` 是要匹配的值，`pattern` 是匹配模式，`branch` 是语句或表达式。若匹配通过，则进入 `branch0`，且将匹配模式中声明的变量加入作用域。否则，进入 `branch1`。

若为 `if is` 语句，则 `else` 分支为可选。


例如：

```aoi
if a is some as b then {
    printLine b;
}
```

其中，`some as b` 是一个匹配模式，它判断一个可空类型是否是情况 `some`，并声明了一个变量 `b`。若匹配的值是 `some`，则将该情况下的值赋给 `b`。同时，该变量作用域为之后的语句块，在块中，`b` 的值被打印了出来。

## `when` 语句和 `when` 表达式

`when` 语句或表达式语法如下：

```
when value {
is pattern0 then branch0
is pattern1 then branch1
...
else branchElse
}
```

其中，`value` 是要匹配的值，`pattern` 是匹配模式，`branch` 是语句或表达式。从上到下依次进行匹配。若匹配通过，则进入分支，并将匹配模式中声明的变量加入作用域，分支执行完后跳出 `when` 语句或表达式，不会继续匹配。若匹配不通过，则继续匹配下一个分支。最终，若匹配全不通过，则进入 `else` 分支。

若为 `when` 语句，或前面的分支覆盖了所有情况，则 `else` 分支为可选。

例如：

```aoi
when a {
is > 0 then {
    printLine "positive";
}
is < 0 then {
    printLine "negative";
}
else {
    printLine "zero";
}
}
```

其中，`> 0` `< 0` 是匹配模式，用于判断 `a` 是否大于或小于 `0`。以上代码判断了 `a` 的正负性并打印。

## 匹配模式

匹配模式有下面几种：

- 判断是否满足条件

    - `value`

        假设要匹配的值为 `value0`。若匹配模式为一个表达式 `value`，若 `value` 和 `value0` 之间实现了等量关系，则判断是否 `value0 == value`。若是，则匹配通过。

        例如，`a is 42` 判断 `a` 的值是否等于 `42`。

    - `op`

        假设要匹配的值为 `value0`。若匹配模式为一个表达式但不满足上一项的条件，则被识别为一个一元运算符 `op`，若 `op value0` 的值为 `true`，则匹配通过。

        例如，若定义了 `isEven` 运算符，`isEven a` 判断 `a` 是否为偶数，则 `a is isEven` 判断 `a` 是否为偶数。

    - `op value`

        假设要匹配的值为 `value0`。若匹配模式为两个表达式，则分别识别为二元运算符 `op` 和值 `value`。若 `value0 op value` 的值为 `true`，则匹配通过。

        例如，`a is >= 42` 判断 `a` 的值是否大于等于 `42`。
    
    - 逻辑运算

        - `pattern0 and pattern1`

            若两个 `pattern` 均匹配通过，则匹配通过。否则匹配不通过。判断是短路的，若前者不通过，则不判断后者。
        
        - `pattern0 xor pattern1`

            若两个 `pattern` 恰中有一个匹配通过，则匹配通过。否则匹配不通过。

            `pattern0` 和 `pattern1` 中不能声明变量，因为不能保证它们匹配通过。
        
        - `pattern0 or pattern1`

            若两个 `pattern` 中至少有一个匹配通过，则匹配通过。否则匹配不通过。判断是短路的，若前者通过，则不判断后者。

            `pattern0` 和 `pattern1` 中不能声明变量。

        以上三种情况按照与、异或、或的优先级结合，相同类型左结合。
        
        - `not pattern`

            若 `pattern` 匹配不通过，则匹配通过。否则匹配不通过。

            `pattern` 中不能声明变量。

        例如，`a is >= 0 and <= 42 or -42` 判断 `a` 的值是否在 `0` 到 `42` 之间或为 `-42`。

- 解构复合类型

    - `(pattern0, pattern1, ...)`

        解构判断一个元组。判断元组的第 i 项是否满足第 i 个 `pattern`。若全部满足，则匹配通过。判断是短路的，若某处不通过，则不判断后续内容。

        其中任意 `pattern` 为可选，若为空，则跳过该元素。例如，`a is (4, , 2)` 判断是否满足 `a` 的第一个元素为 `4`，第三个元素为 `2`。
    
    - `{ pattern00, pattern01, ..., name0: pattern10, name1: pattern11, ..., [value0]: pattern20, [value1]: pattern21, ... }`

        解构判断 `value0` 的字段或属性的值是否满足对应 `pattern`。若全部满足，则匹配通过。判断是短路的，若某处不通过，则不判断后续内容。

        若解构的对象不是数组，则必须提供属性或字段名、属性名或是索引。

        例如，`a is { >= 0, length: >= 3, [2]: >= 42 }` 判断是否满足 `a` 第一个元素大于等于 `0`，`a` 的长度大于等于 `2` 且第三个元素大于等于 `42`。
    
- 解构联合体

    用 `Condition pattern as declaration` 解构联合体。

    其中，`Condition` 为联合体的一个情况，`pattern` 是一个匹配模式，`declaration` 是一个声明模式。若联合体为 `Condition` 情况，且该情况下对应的值满足 `pattern`，则匹配通过，并将该情况下的值赋值给 `declaration`。

    例如，有如下联合体：

    ```aoi
    union Foo {
        Bar: int;
        Baz: float;
    }
    ```

    则对于 `Foo` 的实例 `a`，`a is Foo::Bar >= 0 as b` 判断 `a` 是否为 `Bar` 的情况，并且对应的 `int` 值大于等于 `0`。若匹配通过，则会将对应的 `int` 值赋值给 `b`。

    `pattern` 为可选。`as` 及其之后的内容为可选，若没有，则不声明变量。

- 判断动态类型的实类型

    用 `Type pattern as declaration` 判断类型。

    其中，`Type` 为一个类型，`pattern` 是一个匹配模式，`declaration` 是一个声明模式。若动态类型的实类型为 `Type`，且该情况下对应的值满足 `pattern`，则匹配通过，并将该情况下的值赋值给 `declaration`。
